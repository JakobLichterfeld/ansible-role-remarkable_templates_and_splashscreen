---
- name: Converge
  hosts: all
  gather_facts: true
  become: true

  pre_tasks:
    - name: Populate ansible user name
      ansible.builtin.set_fact:
        ansible_user: "root"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      when: ansible_os_family == "Debian"

    - name: Wait for systemd to complete initialization.  # noqa: command-instead-of-module
      ansible.builtin.command: systemctl is-system-running
      register: systemctl_status
      until: >
        'running' in systemctl_status.stdout or
        'degraded' in systemctl_status.stdout
      retries: 30
      delay: 5
      when: ansible_service_mgr == 'systemd'
      changed_when: false
      failed_when: systemctl_status.rc > 1

    - name: Simulate Remarkable File System
      block:
        - name: Simulate Remarkable File System - Simulate Templates
          ansible.builtin.file:
            path: "/usr/share/remarkable/templates/"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'

        - name: Simulate Remarkable File System - Simulate Splash Screen
          ansible.builtin.file:
            path: "/usr/share/remarkable/suspended.png"
            state: touch
            mode: '0644'
            modification_time: preserve
            access_time: preserve

        - name: Simulate Splash Screen Source Directory
          ansible.builtin.file:
            path: /home/runner/work/ansible-role-remarkable_templates_and_splashscreen/ansible-role-remarkable_templates_and_splashscreen/molecule/default/splashscreens_to_copy
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'

        - name: Simulate Splash Screen Source File
          ansible.builtin.file:
            path: /home/runner/work/ansible-role-remarkable_templates_and_splashscreen/ansible-role-remarkable_templates_and_splashscreen/molecule/default/splashscreens_to_copy/suspended.png
            state: touch
            mode: '0644'
            modification_time: preserve
            access_time: preserve

        - name: Simulate Templates Source Directory
          ansible.builtin.file:
            path: /home/runner/work/ansible-role-remarkable_templates_and_splashscreen/ansible-role-remarkable_templates_and_splashscreen/molecule/default/templates_to_copy
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'

        - name: Simulate Templates Source File
          ansible.builtin.file:
            path: /home/runner/work/ansible-role-remarkable_templates_and_splashscreen/ansible-role-remarkable_templates_and_splashscreen/molecule/default/templates_to_copy/templates.json
            state: touch
            mode: '0644'
            modification_time: preserve
            access_time: preserve

        - name: Install rsync
          ansible.builtin.package:
            name:
              - rsync
            state: present

  roles:
    - role: jakoblichterfeld.remarkable_templates_and_splashscreen
